<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../element/list-item.html">

<polymer-element name="view-main">
	<template>
		<template repeat="{{item in items}}">
			<list-item caption="{{item.value.caption}}" text="{{item.value.description}}" hours="{{item.value.hours}}" href="/todos/{{item.id}}" 
					   item="{{item}}" onPostpone="{{savePostpone}}" onDone="{{saveDone}}"></list-item>
		</template>
		<template if="{{totalItemsCount == 0}}">
			<template if="{{!isAllDone}}">
				<h3>Seems like today's tasks are done!</h3>
				<p>
					Get yourself some rest, 
					you have deserved it!
				</p>
				<a href="#" on-tap="{{fetchNewTodaysTaskList}}">No! Give me more things to do!</a>
			</template>
			<template if="{{isAllDone}}">
				<h3>You are super!</h3>
				<p>
					There is absolutely nothing to do anymore. Add some 
					new tasks and keep youself busy!
				</p>
			</template>
		</template>
	</template>
	<script>
		(function(app) {
			
			function isDateToday(dateString) {
				var date = new Date(dateString);
				var today = new Date();
				return ((date.getDate() + date.getMonth() + date.getYear()) <= 
					    (today.getDate() + today.getMonth() + today.getYear()));
			}
			
			Polymer({
				
				isAllDone: false,
				
				postponedItemsCount: 0,
				doneItemsCount: 0,
				totalItemsCount: 0,
								
				created: function() {
					var self = this;
					this.items = [];
					
					this.savePostpone = function() {
						self.savePostpone_.apply(self, arguments);
					};
					
					this.saveDone = function() {
						self.saveDone_.apply(self, arguments);
					};
					
					this.fetchTodaysTaskList();
				},
				
				itemsChanged: function() {
					this.totalItemsCount = this.items.length - this.postponedItemsCount - this.doneItemsCount;
					console.log(this.totalItemsCount);
				},
				
				postponedItemsCountChanged: function() {
					this.itemsChanged();
				},
				doneItemsCountChanged: function() {
					this.itemsChanged();
				},
				
				/**
				 * Fetch today's tasklist.
				 */
				fetchTodaysTaskList: function() {
					var self = this;
					app.db.todo.listTodaysTasks(function(err, resp) {
						if (err) {
							throw err;
						}
						self.items = resp.rows;
					});
				},
				
				/**
				 * Request new collection of tasks for today.
				 */
				fetchNewTodaysTaskList: function(evt) {
					evt.preventDefault();
					var self = this;
					app.db.todo.requestNewTodaysTaskList(function(err, resp) {
						if (err) {
							throw err;
						}
						if (resp.length <= 0) {
							self.items = [];
							self.isAllDone = true;
						}
						else {
							self.fetchTodaysTaskList();
						}
					});
				},
				
				savePostpone_: function(item, callback) {
					var self = this;
					if (isDateToday(item.deadline)) {
						callback({
							success: false,
							message: "Hey! You can’t remove " + item.value.caption + " from today’s list. " + 
								"Due is tomorrow and you don’t have any other time to do it.<br><br>" + 
								"Dude, just do it."
						});
					}
					else {
						app.db.todo.postpone(item.id, function(err, resp) {
							if (err) {
								callback({
									success: false,
									message: err
								});
								return;
							}
							callback({
								success: true,
								message: "<i>" + item.value.caption + "</i> postponed."
							});
							self.postponedItemsCount++;
						});
					}
				},
				
				saveDone_: function(item, callback) {
					var self = this;
					app.db.todo.updateUsedHours(item.id, item.value.hours, function(err, resp) {
						if (err) {
							return;
						}
						callback({
							success: true,
							message: "Great! <i>" + item.value.caption + "</i> done.<br><br>" + 
								(self.items.length - 1) + " more tasks for today."
						});
						self.doneItemsCount++;
					});
				}
				
			});
			
		})(window.TodAi);
	</script>
</polymer-element>
