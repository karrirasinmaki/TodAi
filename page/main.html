<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../element/list-item.html">

<polymer-element name="view-main">
	<template>
		<template repeat="{{item in items}}">
			<list-item caption="{{item.value.caption}}" text="{{item.value.description}}" hours="{{item.value.hours}}" href="/todos/{{item.id}}" 
					   item="{{item}}" onPostpone="{{savePostpone}}" onDone="{{saveDone}}"></list-item>
		</template>
	</template>
	<script>
		(function(app) {
			
			function isDateToday(dateString) {
				var date = new Date(dateString);
				var today = new Date();
				return ((date.getDate() + date.getMonth() + date.getYear()) <= 
					    (today.getDate() + today.getMonth() + today.getYear()));
			}
			
			Polymer({
								
				created: function() {
					var self = this;
					this.items = [];
					
					this.savePostpone = function() {
						self.savePostpone_.apply(self, arguments);
					};
					
					this.saveDone = function() {
						self.saveDone_.apply(self, arguments);
					};
					
					window.TodAi.db.todo.listTodaysTasks(function(err, resp) {
						if (err) {
							throw err;
						}
						self.items = resp.rows;
						console.log(self.items);
					});
				},
				
				savePostpone_: function(item, callback) {
					app.db.todo.get(item.id, function(err, resp) {
						if (err) {
							
						}
						else if (isDateToday(resp.deadline)) {
							callback({
								success: false,
								message: "Hey! You can’t remove " + item.value.caption + " from today’s list. " + 
									"Due is tomorrow and you don’t have any other time to do it.<br><br>" + 
									"Dude, just do it."
							});
						}
						else {
							callback({
								success: true,
								message: "<i>" + item.value.caption + "</i> postponed."
							});
						}
					});
				},
				
				saveDone_: function(item, callback) {
					var self = this;
					app.db.todo.updateUsedHours(item.id, -item.value.hours, function(err, resp) {
						if (err) {
						}
						else {
							callback({
								success: true,
								message: "Great! <i>" + item.value.caption + "</i> done.<br><br>" + 
									(self.items.length - 1) + " more tasks for today."
							});
						}
					});
				}
				
			});
			
		})(window.TodAi);
	</script>
</polymer-element>
